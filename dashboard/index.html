<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFT Cockpit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .glass {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">

    <!-- Navbar -->
    <nav class="glass sticky top-0 z-50 px-6 py-3 flex justify-between items-center border-b border-gray-800">
        <div class="flex items-center gap-3">
            <div id="heartbeat"
                class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)] transition-colors duration-200">
            </div>
            <h1
                class="text-xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                HFT TERMINAL <span class="text-xs text-gray-500 font-mono ml-2">v0.8.0</span>
            </h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex flex-col items-end">
                <span class="text-xs text-gray-400">RTT</span>
                <span id="rtt-display" class="font-mono text-blue-400">0 µs</span>
            </div>
        </div>
    </nav>

    <!-- Main Grid -->
    <main class="p-6 grid grid-cols-12 gap-6 max-w-[1920px] mx-auto">

        <!-- Left Column: Controls & Stats (3 cols) -->
        <div class="col-span-12 lg:col-span-3 space-y-6">

            <!-- Risk Settings -->
            <div class="glass rounded-xl p-5">
                <h2 class="text-sm font-semibold text-gray-400 mb-4 uppercase tracking-wider">Risk Settings</h2>

                <!-- Max Loss Toggle -->
                <div class="flex items-center justify-between mb-2">
                    <label class="text-xs text-gray-500 uppercase">Max Loss Limit</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="max-loss-toggle" class="sr-only peer" onchange="toggleMaxLoss()">
                        <div
                            class="w-9 h-5 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600">
                        </div>
                    </label>
                </div>

                <!-- Max Loss Input -->
                <div id="max-loss-container" class="opacity-50 pointer-events-none transition-opacity">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <span class="text-gray-500">$</span>
                        </div>
                        <input type="number" id="max-loss-input" value="50"
                            class="w-full bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 pl-7"
                            onchange="updateRiskConfig()">
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="glass rounded-xl p-5">
                <h2 class="text-sm font-semibold text-gray-400 mb-4 uppercase tracking-wider">Engine Control</h2>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="controlEngine('START')"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold transition-all active:scale-95 shadow-lg shadow-emerald-900/20">
                        START
                    </button>
                    <button onclick="controlEngine('STOP')"
                        class="bg-rose-600 hover:bg-rose-500 text-white py-3 rounded-lg font-bold transition-all active:scale-95 shadow-lg shadow-rose-900/20">
                        STOP
                    </button>
                </div>
                <button onclick="confirmFlatten()"
                    class="w-full bg-orange-600 hover:bg-orange-500 text-white py-3 rounded-lg font-bold transition-all active:scale-95 border border-orange-400/30">
                    FLATTEN ALL
                </button>
            </div>

            <!-- Strategy Selector -->
            <div class="glass rounded-xl p-5">
                <h2 class="text-sm font-semibold text-gray-400 mb-4 uppercase tracking-wider">Strategy</h2>
                <select id="strategy-select" onchange="changeStrategy()"
                    class="w-full bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    <!-- Options populated dynamically -->
                </select>
            </div>

        </div>

        <!-- Middle Column: Active Position & Chart (6 cols) -->
        <div class="col-span-12 lg:col-span-6 space-y-6">
            <!-- Active Position -->
            <div class="glass rounded-xl p-5 relative overflow-hidden group h-full flex flex-col">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z" />
                    </svg>
                </div>
                <h2 class="text-sm font-semibold text-gray-400 mb-1">Active Position</h2>
                <div class="flex items-baseline gap-2">
                    <span id="position-amt" class="text-3xl font-mono font-bold text-white">0.00</span>
                    <span class="text-sm text-gray-500">BTC</span>
                </div>
                <div class="mt-4 flex flex-col flex-1">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-semibold text-gray-400">Real-time PnL</h2>
                        <div class="flex items-center gap-2">
                            <span id="current-pnl" class="text-2xl font-mono font-bold text-white">$0.00</span>
                        </div>
                    </div>
                    <div class="flex-1 relative w-full min-h-[300px]">
                        <canvas id="pnlChart"></canvas>
                    </div>
                </div>

                <!-- Logs -->
                <div class="mt-4 pt-4 border-t border-gray-800">
                    <h2 class="text-sm font-semibold text-gray-400 mb-2">System Logs</h2>
                    <div id="logs-container"
                        class="h-[150px] overflow-y-auto font-mono text-xs space-y-1 p-2 bg-gray-900/50 rounded border border-gray-800">
                        <!-- Logs injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: History (3 cols) -->
        <div class="col-span-12 lg:col-span-3">
            <div class="glass rounded-xl p-5 h-full flex flex-col">
                <h2 class="text-sm font-semibold text-gray-400 mb-4">Recent Trades</h2>
                <div class="flex-1 overflow-y-auto">
                    <table class="w-full text-left text-xs">
                        <thead class="text-gray-500 border-b border-gray-700 sticky top-0 bg-gray-900/90 backdrop-blur">
                            <tr>
                                <th class="pb-2">Time</th>
                                <th class="pb-2">Side</th>
                                <th class="pb-2 text-right">Price</th>
                                <th class="pb-2 text-right">Qty</th>
                            </tr>
                        </thead>
                        <tbody id="trades-body" class="divide-y divide-gray-800">
                            <!-- Trades injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Flatten Confirmation Modal -->
    <div id="flatten-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
        <div class="bg-gray-800 border border-red-500/50 rounded-xl p-6 max-w-sm w-full shadow-2xl shadow-red-900/50">
            <h3 class="text-xl font-bold text-red-500 mb-2">⚠️ EMERGENCY FLATTEN</h3>
            <p class="text-gray-300 text-sm mb-6">
                Are you sure you want to close ALL positions immediately? This action cannot be undone.
            </p>
            <div class="flex gap-3">
                <button onclick="closeModal()"
                    class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-medium">Cancel</button>
                <button onclick="executeFlatten()"
                    class="flex-1 bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg font-bold">CONFIRM</button>
            </div>
        </div>
    </div>
    <script>
        // --- State ---
        const API_URL = 'http://localhost:3000/api';
        let pnlChart;
        let lastTradeCount = -1;
        let initialBalance = 1000; // Default fallback

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            loadStrategies(); // Fetch strategies
            startSSE();
            pollHistory();
            setInterval(pollHistory, 2000);
            toggleMaxLoss(); // Initialize max loss toggle state
        });

        // --- Strategy Loading ---
        async function loadStrategies() {
            try {
                const res = await fetch(`${API_URL}/strategies`);
                const strategies = await res.json();
                const select = document.getElementById('strategy-select');

                select.innerHTML = strategies.map(s =>
                    `<option value="${s}">${s.replace('_', ' ')}</option>`
                ).join('');

                // Set active strategy
                const statusRes = await fetch(`${API_URL}/status`);
                const status = await statusRes.json();
                select.value = status.active_strategy;

            } catch (e) {
                console.error("Failed to load strategies", e);
                logToUI("Failed to load strategies");
            }
        }

        // --- Risk Control ---
        function toggleMaxLoss() {
            const toggle = document.getElementById('max-loss-toggle');
            const container = document.getElementById('max-loss-container');

            if (toggle.checked) {
                container.classList.remove('opacity-50', 'pointer-events-none');
                updateRiskConfig(); // Send current input value
            } else {
                container.classList.add('opacity-50', 'pointer-events-none');
                // Send "Infinite" limit (a very large number)
                sendConfig(1000000000, 0);
            }
        }

        function updateRiskConfig() {
            const toggle = document.getElementById('max-loss-toggle');
            if (!toggle.checked) return; // Don't update if disabled (handled by toggle off)

            const maxLoss = parseFloat(document.getElementById('max-loss-input').value) || 50;
            sendConfig(maxLoss, 0);
        }

        async function sendConfig(maxLoss, targetProfit) {
            try {
                await fetch(`${API_URL}/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ max_loss: maxLoss, target_profit: targetProfit })
                });
                logToUI(`Risk Config Updated: Max Loss ${maxLoss > 1000000 ? 'DISABLED' : '$' + maxLoss}`);
            } catch (e) {
                logToUI(`Error updating config: ${e.message}`);
            }
        }

        // --- Chart.js ---
        function initChart() {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Account Value',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 3,
                        fill: true,
                        stepped: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { color: '#6b7280', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        async function loadPnlHistory() {
            try {
                const res = await fetch(`${API_URL}/pnl_series`);
                const history = await res.json();

                // Reset
                pnlChart.data.labels = ['Start'];
                pnlChart.data.datasets[0].data = [initialBalance];

                // We don't have exact trade counts for history points easily without full trade history
                // So we'll just index them 1..N
                history.forEach((point, index) => {
                    const val = point[1];
                    pnlChart.data.labels.push(`Trade ${index + 1}`);
                    pnlChart.data.datasets[0].data.push(initialBalance + val);
                });

                // Sync trade count from status
                const statusRes = await fetch(`${API_URL}/status`);
                const status = await statusRes.json();
                lastTradeCount = status.trade_count;

                pnlChart.update();
            } catch (e) {
                console.error("Failed to load history", e);
            }
        }

        function updateChartBase() {
            loadPnlHistory();
        }

        // --- SSE Handling ---
        function startSSE() {
            const eventSource = new EventSource(`${API_URL}/sse`);

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateDashboard(data);
            };

            eventSource.onerror = (err) => {
                console.error("SSE Error:", err);
                document.getElementById('heartbeat').classList.replace('bg-green-500', 'bg-red-500');
            };
        }

        function updateDashboard(data) {
            // 1. Heartbeat
            const now = Date.now();
            const lastTick = data.last_tick; // ms
            const latency = now - lastTick;
            const hb = document.getElementById('heartbeat');

            if (latency < 1000) {
                hb.classList.replace('bg-red-500', 'bg-green-500');
                hb.classList.add('animate-pulse');
            } else {
                hb.classList.replace('bg-green-500', 'bg-red-500');
                hb.classList.remove('animate-pulse');
            }

            // 2. PnL Text
            const pnl = data.pnl;
            const totalValue = initialBalance + pnl;

            const pnlEl = document.getElementById('current-pnl');
            pnlEl.innerText = `$${totalValue.toFixed(2)}`;
            pnlEl.className = `text-2xl font-mono font-bold ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;

            // 3. Update Chart (Trade Driven)
            const currentTradeCount = data.trade_count || 0;

            if (lastTradeCount !== -1 && currentTradeCount > lastTradeCount) {
                // New trade(s) detected
                for (let i = lastTradeCount + 1; i <= currentTradeCount; i++) {
                    pnlChart.data.labels.push(`Trade ${i}`);
                    pnlChart.data.datasets[0].data.push(totalValue);
                }

                // Color logic
                const isProfit = totalValue >= initialBalance;
                pnlChart.data.datasets[0].borderColor = isProfit ? '#10b981' : '#f43f5e';
                pnlChart.data.datasets[0].backgroundColor = isProfit ? 'rgba(16, 185, 129, 0.1)' : 'rgba(244, 63, 94, 0.1)';

                pnlChart.update();
                lastTradeCount = currentTradeCount;
            } else if (lastTradeCount === -1) {
                // First sync
                lastTradeCount = currentTradeCount;
            }
        }

        async function controlEngine(command) {
            try {
                await fetch(`${API_URL}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });
                logToUI(`Command sent: ${command}`);
            } catch (e) {
                logToUI(`Error: ${e.message}`);
            }
        }

        function confirmFlatten() {
            document.getElementById('flatten-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('flatten-modal').classList.add('hidden');
        }

        async function executeFlatten() {
            closeModal();
            try {
                await fetch(`${API_URL}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: 'FLATTEN', confirm: true })
                });
                logToUI("FLATTEN command sent!");
            } catch (e) {
                logToUI(`Error: ${e.message}`);
            }
        }

        async function changeStrategy() {
            const strategy = document.getElementById('strategy-select').value;
            try {
                const res = await fetch(`${API_URL}/strategy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy })
                });
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.error);
                    return;
                }
                logToUI(`Strategy changed to ${strategy}`);
            } catch (e) {
                logToUI(`Error: ${e.message}`);
            }
        }

        async function pollHistory() {
            try {
                // 1. Get History
                const res = await fetch(`${API_URL}/history?limit=20`);
                const trades = await res.json();
                renderTrades(trades);

                // 2. Get Logs
                const logRes = await fetch(`${API_URL}/logs`);
                const logs = await logRes.json();
                renderLogs(logs);

                // 3. Get Status for Position/RTT/Balance
                const statusRes = await fetch(`${API_URL}/status`);
                const status = await statusRes.json();

                document.getElementById('position-amt').innerText = status.current_position.toFixed(4);
                document.getElementById('rtt-display').innerText = `${status.last_order_rtt_ns / 1000} µs`;

                // Update Initial Balance if available
                if (status.initial_balance > 0 && initialBalance !== status.initial_balance) {
                    initialBalance = status.initial_balance;
                    // Reload chart history with new base if it changed significantly (or just once)
                    if (initialBalance != 1000) {
                        loadPnlHistory();
                    }
                }

            } catch (e) {
                // console.error(e);
            }
        }

        function renderTrades(trades) {
            const tbody = document.getElementById('trades-body');
            tbody.innerHTML = trades.map(t => `
                <tr class="hover:bg-gray-800/50 transition-colors">
                    <td class="py-1 text-gray-400 font-mono">${new Date(t.exchange_ts_ms).toLocaleTimeString()}</td>
                    <td class="py-1 font-bold ${t.side.includes('Buy') ? 'text-green-400' : 'text-red-400'}">${t.side}</td>
                    <td class="py-1 text-right font-mono">${t.price.toFixed(2)}</td>
                    <td class="py-1 text-right font-mono text-gray-300">${t.quantity}</td>
                </tr>
            `).join('');
        }

        function renderLogs(logs) {
            const container = document.getElementById('logs-container');
            container.innerHTML = logs.map(l => `<div class="text-gray-400 border-l-2 border-gray-700 pl-2 hover:border-blue-500 transition-colors">${l}</div>`).join('');
        }

        function logToUI(msg) {
            // Optimistic log
            const container = document.getElementById('logs-container');
            container.innerHTML += `<div class="text-yellow-400 border-l-2 border-yellow-600 pl-2">${msg}</div>`;
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>

</html>
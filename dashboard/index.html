<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFT Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <style>
        .glass {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Sticky Timeline Headers */
        .header-year {
            position: sticky;
            top: 0px;
            z-index: 30;
            background: #111827;
            /* gray-900 */
            border-bottom: 1px solid #374151;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: bold;
            color: #9ca3af;
        }

        .header-month {
            position: sticky;
            top: 25px;
            /* Height of year header approx */
            z-index: 20;
            background: #1f2937;
            /* gray-800 */
            border-bottom: 1px solid #374151;
            padding: 2px 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #9ca3af;
        }

        .header-day {
            position: sticky;
            top: 48px;
            /* Height of year + month approx */
            z-index: 10;
            background: #374151;
            /* gray-700 */
            border-bottom: 1px solid #4b5563;
            padding: 2px 16px;
            font-size: 0.7rem;
            font-weight: 500;
            color: #d1d5db;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">

    <!-- Navbar -->
    <nav class="glass sticky top-0 z-50 px-6 py-3 flex justify-between items-center border-b border-gray-800">
        <div class="flex items-center gap-3">
            <div id="heartbeat"
                class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)] transition-colors duration-200">
            </div>
            <h1
                class="text-xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                HFT TERMINAL <span class="text-xs text-gray-500 font-mono ml-2">v0.8.0</span>
            </h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex flex-col items-end">
                <span class="text-xs text-gray-400">RTT</span>
                <span id="rtt-display" class="font-mono text-blue-400">0 µs</span>
            </div>
        </div>
    </nav>

    <!-- Main Grid -->
    <main class="p-6 grid grid-cols-12 gap-6 max-w-[1920px] mx-auto">

        <!-- Left Column: Controls & Stats (3 cols) -->
        <div class="col-span-12 lg:col-span-3 space-y-6">

            <!-- Risk Settings -->
            <div class="glass rounded-xl p-5">
                <h2 class="text-sm font-semibold text-gray-400 mb-4 uppercase tracking-wider">Risk Settings</h2>

                <!-- Max Loss Toggle -->
                <div class="flex items-center justify-between mb-2">
                    <label class="text-xs text-gray-500 uppercase">Max Loss Limit</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="max-loss-toggle" class="sr-only peer" onchange="toggleMaxLoss()">
                        <div
                            class="w-9 h-5 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600">
                        </div>
                    </label>
                </div>

                <!-- Max Loss Input -->
                <div id="max-loss-container" class="opacity-50 pointer-events-none transition-opacity">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <span class="text-gray-500">$</span>
                        </div>
                        <input type="number" id="max-loss-input" value="50"
                            class="w-full bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 pl-7"
                            onchange="updateRiskConfig()">
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="glass rounded-xl p-5">
                <h2 class="text-sm font-semibold text-gray-400 mb-4 uppercase tracking-wider">Engine Control</h2>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="controlEngine('START')"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold transition-all active:scale-95 shadow-lg shadow-emerald-900/20">
                        START
                    </button>
                    <button onclick="controlEngine('STOP')"
                        class="bg-rose-600 hover:bg-rose-500 text-white py-3 rounded-lg font-bold transition-all active:scale-95 shadow-lg shadow-rose-900/20">
                        STOP
                    </button>
                </div>
                <button onclick="confirmFlatten()"
                    class="w-full bg-orange-600 hover:bg-orange-500 text-white py-3 rounded-lg font-bold transition-all active:scale-95 border border-orange-400/30">
                    FLATTEN ALL
                </button>
            </div>

            <!-- Strategy Selector -->
            <div class="glass rounded-xl p-5">
                <h2 class="text-sm font-semibold text-gray-400 mb-4 uppercase tracking-wider">Strategy</h2>
                <select id="strategy-select" onchange="changeStrategy()"
                    class="w-full bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    <!-- Options populated dynamically -->
                </select>
            </div>

            <!-- System Logs -->
            <div class="glass rounded-xl p-5">
                <h2 class="text-sm font-semibold text-gray-400 mb-2">System Logs</h2>
                <div id="logs-container"
                    class="h-[150px] overflow-y-auto font-mono text-xs space-y-1 p-2 bg-gray-900/50 rounded border border-gray-800">
                    <!-- Logs injected here -->
                </div>
            </div>

        </div>

        <!-- Middle Column: Active Position & Chart (6 cols) -->
        <div class="col-span-12 lg:col-span-6 space-y-6">
            <!-- Stats Row -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass rounded-xl p-4 flex flex-col items-center justify-center">
                    <span class="text-xs text-gray-400 uppercase tracking-wider">Total PnL</span>
                    <span id="current-pnl" class="text-2xl font-mono font-bold text-gray-500">--</span>
                </div>
                <div class="glass rounded-xl p-4 flex flex-col items-center justify-center">
                    <span class="text-xs text-gray-400 uppercase tracking-wider">Unrealized PnL</span>
                    <span id="unrealized-pnl" class="text-xl font-mono font-bold text-gray-500">--</span>
                </div>
                <div class="glass rounded-xl p-4 flex flex-col items-center justify-center">
                    <span class="text-xs text-gray-400 uppercase tracking-wider">Position</span>
                    <span id="position-amt" class="text-xl font-mono font-bold text-blue-400">0.0000</span>
                </div>
                <div class="glass rounded-xl p-4 flex flex-col items-center justify-center">
                    <span class="text-xs text-gray-400 uppercase tracking-wider">Available</span>
                    <span id="available-balance" class="text-xl font-mono font-bold text-emerald-400">--</span>
                </div>
            </div>
            <!-- Active Position -->
            <div class="glass rounded-xl p-5 relative overflow-hidden group h-[500px] flex flex-col">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <select id="time-range" onchange="handleTimeRangeChange()"
                        class="bg-gray-800 text-xs text-gray-300 border border-gray-700 rounded px-2 py-1 focus:outline-none focus:border-blue-500">
                        <option value="SESSION" selected>Current Session</option>
                        <option value="ALL">All Time</option>
                        <option value="TODAY">Today</option>
                        <option value="MONTH">This Month</option>
                        <option value="YEAR">This Year</option>
                    </select>
                    <button onclick="resetZoom()"
                        class="bg-gray-800 hover:bg-gray-700 text-xs text-gray-300 border border-gray-700 rounded px-2 py-1 transition-colors">
                        Reset Zoom
                    </button>
                </div>
                <canvas id="pnlChart"></canvas>
            </div>

        </div>
        </div>

        <!-- Right Column: History (3 cols) -->
        <div class="col-span-12 lg:col-span-3">
            <div class="glass rounded-xl p-5 h-full flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-semibold text-gray-400">Recent Trades</h2>
                    <button onclick="clearHistory()"
                        class="text-xs bg-red-900/30 hover:bg-red-900/50 text-red-400 px-2 py-1 rounded transition-colors">
                        Clear
                    </button>
                </div>
                <!-- Timeline Container -->
                <div id="trades-container" class="flex-1 overflow-y-auto relative">
                    <!-- Trades injected here by JS -->
                </div>
            </div>
        </div>

    </main>

    <!-- Flatten Confirmation Modal -->
    <div id="flatten-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
        <div class="bg-gray-800 border border-red-500/50 rounded-xl p-6 max-w-sm w-full shadow-2xl shadow-red-900/50">
            <h3 class="text-xl font-bold text-red-500 mb-2">⚠️ EMERGENCY FLATTEN</h3>
            <p class="text-gray-300 text-sm mb-6">
                Are you sure you want to close ALL positions immediately? This action cannot be undone.
            </p>
            <div class="flex gap-3">
                <button onclick="closeModal()"
                    class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-medium">Cancel</button>
                <button onclick="executeFlatten()"
                    class="flex-1 bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg font-bold">CONFIRM</button>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        const API_URL = 'http://localhost:3000/api';
        let pnlChart;
        let lastTradeCount = -1;
        let initialBalance = 1000; // Default fallback
        const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        // New State for Filtering
        let allPnlData = []; // Stores { ts: ms, val: number, label: string }
        let timeFilter = 'SESSION';

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            loadStrategies(); // Fetch strategies
            startSSE();
            pollHistory();
            setInterval(pollHistory, 2000);
            toggleMaxLoss(); // Initialize max loss toggle state
            logToUI(`Detected Timezone: ${userTimeZone}`);
            loadPnlHistory(); // Initial load
        });

        // --- Strategy Loading ---
        async function loadStrategies() {
            try {
                const res = await fetch(`${API_URL}/strategies`);
                const strategies = await res.json();
                const select = document.getElementById('strategy-select');

                select.innerHTML = strategies.map(s =>
                    `<option value="${s}">${s.replace('_', ' ')}</option>`
                ).join('');

                // Set active strategy
                const statusRes = await fetch(`${API_URL}/status`);
                const status = await statusRes.json();
                select.value = status.active_strategy;

            } catch (e) {
                console.error("Failed to load strategies", e);
                logToUI("Failed to load strategies");
            }
        }

        // --- Risk Control ---
        function toggleMaxLoss() {
            const toggle = document.getElementById('max-loss-toggle');
            const container = document.getElementById('max-loss-container');

            if (toggle.checked) {
                container.classList.remove('opacity-50', 'pointer-events-none');
                updateRiskConfig(); // Send current input value
            } else {
                container.classList.add('opacity-50', 'pointer-events-none');
                // Send "Infinite" limit (a very large number)
                sendConfig(1000000000, 0);
            }
        }

        function updateRiskConfig() {
            const toggle = document.getElementById('max-loss-toggle');
            if (!toggle.checked) return; // Don't update if disabled (handled by toggle off)

            const maxLoss = parseFloat(document.getElementById('max-loss-input').value) || 50;
            sendConfig(maxLoss, 0);
        }

        async function sendConfig(maxLoss, targetProfit) {
            try {
                await fetch(`${API_URL}/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ max_loss: maxLoss, target_profit: targetProfit })
                });
                logToUI(`Risk Config Updated: Max Loss ${maxLoss > 1000000 ? 'DISABLED' : '$' + maxLoss}`);
            } catch (e) {
                logToUI(`Error updating config: ${e.message}`);
            }
        }

        // --- Chart.js ---
        function initChart() {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Account Value',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 3,
                        fill: true,
                        stepped: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy',
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { color: '#6b7280', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        function resetZoom() {
            pnlChart.resetZoom();
        }

        async function handleTimeRangeChange() {
            await loadPnlHistory();
        }

        async function loadPnlHistory() {
            const range = document.getElementById('time-range').value;
            const mode = (range === 'SESSION') ? 'session' : 'historical';

            try {
                const res = await fetch(`${API_URL}/pnl_series?mode=${mode}`);
                const history = await res.json();

                // Reset Data
                allPnlData = [];

                // Add Start Point (approximate TS if needed, using 0 for now as anchor)
                allPnlData.push({ ts: 0, val: initialBalance, label: 'Start' });

                history.forEach((point, index) => {
                    const ts = point[0]; // ms
                    const val = point[1];
                    allPnlData.push({
                        ts: ts,
                        val: initialBalance + val,
                        label: `Trade ${index + 1}` // Or format timestamp
                    });
                });

                // Sync trade count from status
                const statusRes = await fetch(`${API_URL}/status`);
                const status = await statusRes.json();
                lastTradeCount = status.trade_count;

                applyFilter();
            } catch (e) {
                console.error("Failed to load history", e);
            }
        }

        function applyFilter() {
            const range = document.getElementById('time-range').value;
            const now = Date.now();
            let cutoff = 0;

            if (range === 'TODAY') {
                const d = new Date();
                d.setHours(0, 0, 0, 0);
                cutoff = d.getTime();
            } else if (range === 'MONTH') {
                const d = new Date();
                d.setDate(1);
                d.setHours(0, 0, 0, 0);
                cutoff = d.getTime();
            } else if (range === 'YEAR') {
                const d = new Date();
                d.setMonth(0, 1);
                d.setHours(0, 0, 0, 0);
                cutoff = d.getTime();
            }

            // Filter
            // Always include "Start" point if cutoff is 0 (ALL), otherwise filter by TS
            const filtered = allPnlData.filter(p => p.ts >= cutoff || (range === 'ALL' && p.ts === 0));

            // Update Chart
            pnlChart.data.labels = filtered.map(p => p.label);
            pnlChart.data.datasets[0].data = filtered.map(p => p.val);

            // Update Color based on last value
            if (filtered.length > 0) {
                const lastVal = filtered[filtered.length - 1].val;
                const isProfit = lastVal >= initialBalance;
                pnlChart.data.datasets[0].borderColor = isProfit ? '#10b981' : '#f43f5e';
                pnlChart.data.datasets[0].backgroundColor = isProfit ? 'rgba(16, 185, 129, 0.1)' : 'rgba(244, 63, 94, 0.1)';
            }

            pnlChart.update();
        }
        function updateChartBase() {
            loadPnlHistory();
        }

        // --- SSE Handling ---
        function startSSE() {
            const eventSource = new EventSource(`${API_URL}/sse`);

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateDashboard(data);
            };

            eventSource.onerror = (err) => {
                console.error("SSE Error:", err);
                document.getElementById('heartbeat').classList.replace('bg-green-500', 'bg-red-500');
            };
        }

        function updateDashboard(data) {
            // 1. Heartbeat
            const now = Date.now();
            const lastTick = data.last_tick; // ms
            const latency = now - lastTick;
            const hb = document.getElementById('heartbeat');

            if (latency < 1000) {
                hb.classList.replace('bg-red-500', 'bg-green-500');
                hb.classList.add('animate-pulse');
            } else {
                hb.classList.replace('bg-green-500', 'bg-red-500');
                hb.classList.remove('animate-pulse');
            }

            // 2. PnL Text
            const pnl = data.pnl;
            const totalValue = initialBalance + pnl;

            const pnlEl = document.getElementById('current-pnl');
            pnlEl.innerText = `$${totalValue.toFixed(2)}`;
            pnlEl.className = `text-2xl font-mono font-bold ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;

            // 3. Position Text
            // 3c. Unrealized PnL
            if (data.unrealized_pnl !== undefined) {
                const upnl = data.unrealized_pnl;
                const el = document.getElementById('unrealized-pnl');
                if (el) {
                    el.innerText = `$${upnl.toFixed(2)}`;
                    el.className = `text-xl font-mono font-bold ${upnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
                }
            }
            if (data.position !== undefined) {
                document.getElementById('position-amt').innerText = data.position.toFixed(4);
            }

            // 3b. Available Balance
            if (data.available_balance !== undefined) {
                document.getElementById('available-balance').innerText = `$${data.available_balance.toFixed(2)}`;
            }

            // 4. Update Chart (Trade Driven)
            const currentTradeCount = data.trade_count || 0;

            if (lastTradeCount !== -1 && currentTradeCount > lastTradeCount) {
                // New trade(s) detected
                for (let i = lastTradeCount + 1; i <= currentTradeCount; i++) {
                    // Push to Master Data
                    allPnlData.push({
                        ts: data.ts || Date.now(),
                        val: totalValue,
                        label: `Trade ${i}`
                    });
                }
                lastTradeCount = currentTradeCount;

                // Refresh View
                applyFilter();

            } else if (lastTradeCount === -1) {
                // First sync
                lastTradeCount = currentTradeCount;
            }
        }

        async function controlEngine(command) {
            try {
                await fetch(`${API_URL}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });
                logToUI(`Command sent: ${command}`);
            } catch (e) {
                logToUI(`Error: ${e.message}`);
            }
        }

        function confirmFlatten() {
            document.getElementById('flatten-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('flatten-modal').classList.add('hidden');
        }

        async function executeFlatten() {
            closeModal();
            try {
                await fetch(`${API_URL}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: 'FLATTEN', confirm: true })
                });
                logToUI("FLATTEN command sent!");
            } catch (e) {
                logToUI(`Error: ${e.message}`);
            }
        }

        async function changeStrategy() {
            const strategy = document.getElementById('strategy-select').value;
            try {
                const res = await fetch(`${API_URL}/strategy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy })
                });
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.error);
                    return;
                }
                logToUI(`Strategy changed to ${strategy}`);
            } catch (e) {
                logToUI(`Error: ${e.message}`);
            }
        }

        async function clearHistory() {
            if (!confirm('Are you sure you want to clear all trade history?')) return;
            try {
                await fetch(`${API_URL}/history`, { method: 'DELETE' });
                logToUI("Trade history cleared");
                pollHistory(); // Refresh trades list
                loadPnlHistory(); // Refresh P&L graph
            } catch (e) {
                logToUI(`Error clearing history: ${e.message}`);
            }
        }

        async function pollHistory() {
            try {
                // 1. Get History
                const res = await fetch(`${API_URL}/history?limit=20`);
                const trades = await res.json();
                renderTrades(trades);

                // 2. Get Logs
                const logRes = await fetch(`${API_URL}/logs`);
                const logs = await logRes.json();
                renderLogs(logs);

                // 3. Get Status for Position/RTT/Balance
                const statusRes = await fetch(`${API_URL}/status`);
                const status = await statusRes.json();

                document.getElementById('position-amt').innerText = status.current_position.toFixed(4);
                document.getElementById('rtt-display').innerText = `${status.last_order_rtt_ns / 1000} µs`;

                if (status.available_balance) {
                    document.getElementById('available-balance').innerText = `$${status.available_balance.toFixed(2)}`;
                }

                // Update Initial Balance if available
                if (status.initial_balance > 0 && initialBalance !== status.initial_balance) {
                    initialBalance = status.initial_balance;
                    // Reload chart history with new base if it changed significantly (or just once)
                    if (initialBalance != 1000) {
                        loadPnlHistory();
                    }
                }

            } catch (e) {
                // console.error(e);
            }
        }

        function renderTrades(trades) {
            const container = document.getElementById('trades-container');
            if (!container) return;

            // Sort Newest First
            trades.sort((a, b) => b.exchange_ts_ms - a.exchange_ts_ms);

            let html = '';
            let currentYear = null;
            let currentMonth = null;
            let currentDay = null;

            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP",
                "OCT", "NOV", "DEC"];

            trades.forEach(t => {
                const date = new Date(t.exchange_ts_ms);
                const year = date.getFullYear();
                const month = monthNames[date.getMonth()];
                const day = date.getDate();

                // Year Header
                if (year !== currentYear) {
                    html += `<div class="header-year">${year}</div>`;
                    currentYear = year;
                    currentMonth = null; // Reset lower levels
                    currentDay = null;
                }

                // Month Header
                if (month !== currentMonth) {
                    html += `<div class="header-month">${month}</div>`;
                    currentMonth = month;
                    currentDay = null;
                }

                // Day Header
                if (day !== currentDay) {
                    html += `<div class="header-day">Day ${day}</div>`;
                    currentDay = day;
                }

                // Trade Row
                const timeStr = date.toLocaleTimeString('en-US', { timeZone: userTimeZone, hour12: false });
                const sideColor = t.side.includes('Buy') ? 'text-green-400' : 'text-red-400';

                html += `
                <div
                    class="flex justify-between items-center px-4 py-2 border-b border-gray-800 hover:bg-gray-800/50 transition-colors text-xs">
                    <div class="flex items-center gap-2 w-20">
                        <span class="text-gray-500 font-mono">${timeStr}</span>
                    </div>
                    <div class="flex-1 font-bold ${sideColor}">${t.side}</div>
                    <div class="text-right font-mono w-20">${t.price.toFixed(2)}</div>
                    <div class="text-right font-mono text-gray-400 w-16">${t.quantity}</div>
                </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderLogs(logs) {
            const container = document.getElementById('logs-container');
            container.innerHTML = logs.map(l => `<div
                class="text-gray-400 border-l-2 border-gray-700 pl-2 hover:border-blue-500 transition-colors">
                ${l}</div>`).join('');
        }

        function logToUI(msg) {
            // Optimistic log
            const container = document.getElementById('logs-container');
            container.innerHTML += `<div class="text-yellow-400 border-l-2 border-yellow-600 pl-2">
                ${msg}</div>`;
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>

</html>